const fs = require('fs')
const path = require('path')

const ROOT = path.join(__dirname, '..')
const SVGS_DIR = path.join(ROOT, 'src', 'svgs')
const OUT_FILE = path.join(SVGS_DIR, 'index.ts')

function walk(dir) {
	const entries = fs.readdirSync(dir, { withFileTypes: true })
	const files = []
	for (const entry of entries) {
		const full = path.join(dir, entry.name)
		if (entry.isDirectory()) {
			files.push(...walk(full))
		} else if (entry.isFile() && entry.name.toLowerCase().endsWith('.svg')) {
			files.push(full)
		}
	}
	return files
}

function ensureDirExists(dir) {
	if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true })
}

function main() {
	ensureDirExists(SVGS_DIR)
	const files = walk(SVGS_DIR)
	files.sort((a, b) => a.localeCompare(b))

	const rel = files.map(f => `./${path.relative(SVGS_DIR, f).replace(/\\/g, '/')}`)

	const imports = rel.map((p, i) => `import Svg${i} from '${p}'`).join('\n')
	const items = rel.map((p, i) => `\t{ key: './${p.replace(/^\.\//, '')}', Component: Svg${i} }`).join(',\n')

	const content = `// Auto-generated by scripts/gen-svgs-index.js\n// Do not edit manually\n\n${imports}\n\nexport type SvgComponent = React.ComponentType<React.SVGProps<SVGSVGElement>>\n\nexport const svgItems: { key: string; Component: SvgComponent }[] = [\n${items}\n]\n`

	fs.writeFileSync(OUT_FILE, content)
	console.log(`Generated ${OUT_FILE} with ${rel.length} SVGs.`)
}

// Throttle watch trigger by 1s
const WATCH_THROTTLE_MS = 1000
let throttleTimer = null

function startWatch() {
	ensureDirExists(SVGS_DIR)
	const outBasename = path.basename(OUT_FILE)
	try {
		fs.watch(SVGS_DIR, { recursive: true }, (eventType, filename) => {
			// filename may be null on some platforms
			if (!filename) return
			// ignore self writes
			if (path.basename(filename) === outBasename) return
			// only respond to .svg changes
			if (!filename.toLowerCase().endsWith('.svg')) return
			if (throttleTimer) return
			throttleTimer = setTimeout(() => {
				throttleTimer = null
				try {
					main()
				} catch (err) {
					console.error('Error generating index after change:', err)
				}
			}, WATCH_THROTTLE_MS)
		})
		console.log(`Watching ${SVGS_DIR} for SVG changes... (throttle ${WATCH_THROTTLE_MS}ms)`)
	} catch (err) {
		console.error('Failed to start watcher:', err)
	}
}

startWatch()
